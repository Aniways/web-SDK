/*! Aniways 2014-02-13 */
function AniwaysEncodingError(a){this.message=a}window.Aniways={init:function(){document.getElementsByClassName("aniways-wall").length>0?this.addWallObserver():console.log("Can't find element with aniways-wall class")},unicodeMapping:{"​":0,"‌":1,"‍":2,"﻿":3},lengthMapping:{"​":5,"‌":11,"‍":17,"﻿":23},Delimiter:8203,assetsIdsToNames:{},assetsNamesToUrls:{},keywordsPath:"http://api.aniways.com/v2/keywords",assetsPath:"http://api.aniways.com/v2/assets",unicodeToDecimal:function(a){for(var b="",c=4,d=0;d<a.length;d++){var e=this.unicodeMapping[a.charAt(d)];if(void 0===e)return-1;b+=this.unicodeMapping[a.charAt(d)]}return parseInt(b,c)},extractEncodingData:function(a){for(var b={data:[],message:""},c={},d=a.length,e=0;d>e;e++)a.charCodeAt(e)>255&&(c={},c.phraseStart=e,a=this.removeAndRecordImageID(c,a,e),a=this.removeAndRecordDelimiter(c,"subPhraseStart",a,e),a=this.removeAndRecordDelimiter(c,"subPhraseEnd",a,e),a=this.removeAndRecordDelimiter(c,"phraseEnd",a,e),b.data.push(c),e=c.phraseEnd,d=a.length);return b.message=a,b},removeAndRecordImageID:function(a,b,c){var d=this.lengthMapping[b.charAt(c)],e=b.substr(c+1,d);if(a.imageId=this.unicodeToDecimal(e),-1===a.imageId)throw new AniwaysEncodingError("Mallformed image encoding");if(b.charCodeAt(c+d+1)>255&&b.charCodeAt(c+d+1)!==this.Delimiter)throw new AniwaysEncodingError("Mallformed image encoding");return b.substr(0,c)+b.substr(c+d+1)},removeAndRecordDelimiter:function(a,b,c,d){if(a[b]=c.indexOf(String.fromCharCode(this.Delimiter),d),-1===a[b])throw new AniwaysEncodingError("Can't find "+b+" delimiter");return c.substr(0,a[b])+c.substr(a[b]+1)},decodeMessage:function(a){try{return this.unicodeDecoding(a)}catch(b){if(b instanceof AniwaysEncodingError)return this.urlDecoding(a)}},unicodeDecoding:function(a){for(var b=this.extractEncodingData(a),c=b.message,d="",e=0,f=0;f<b.data.length;f++){var g=b.data[f],h=this.assetsNamesToUrls[this.assetsIdsToNames[g.imageId]];void 0===h?(d+=c.substring(e,g.phraseEnd),e=g.phraseEnd):(h=h.substring(0,h.indexOf("::")),d+=c.substring(e,g.subPhraseStart),d+="<img class='aniways-image' src='"+h+"'  title='"+c.substring(g.subPhraseStart,g.subPhraseEnd)+"'>",e=g.subPhraseEnd)}return d+=c.substring(e)},urlDecoding:function(a){var b=a.split("﻿﻿\n\n"),c=b[0];if(b.length<=1)return c;var d=this.getJsonFromUrl(b[1]),e=0;for(var f in d)d.hasOwnProperty(f)&&-1!==f.indexOf("si")&&e++;for(var g="",h=0,i=0;e>i;i++)g+=c.substring(h,parseInt(d["si"+i])),g+="<img class='aniways-image' src='http://az493648.vo.msecnd.net/aniways-assets/android/ldpi/"+d["id"+i]+"'  title='"+c.substring(parseInt(d["si"+i]),parseInt(d["si"+i])+parseInt(d["l"+i]))+"'>",h=parseInt(d["l"+i])+parseInt(d["si"+i]);return g+=c.substring(h)},getJsonFromUrl:function(a){a=a.replace(/&amp;/g,"&"),a=a.match(/((([A-Za-z]{3,9}:(?:\/\/)?)(?:[-;:&=\+\$,\w]+@)?[A-Za-z0-9.-]+|(?:www.|[-;:&=\+\$,\w]+@)[A-Za-z0-9.-]+)((?:\/[\+~%\/.\w-_]*)?\??(?:[-\+=&;%@.\w_]*)#?(?:[\w]*))?)/);for(var b=a[0].split("?")[1],c=b.split("&"),d={},e=0;e<c.length;e++){var f=c[e].split("=");d[f[0]]=f[1]}return d},addWallObserver:function(){var a=document.querySelector(".aniways-wall"),b=new MutationObserver(function(a){a.forEach(function(a){if("childList"===a.type)for(var b=a.addedNodes,c=0;c<b.length;c++){var d=b[c];if("function"==typeof d.getElementsByClassName){var e=d.getElementsByClassName("aniways-text");if(e.length>0){var f=Aniways.decodeMessage(e[0].innerHTML);e[0].innerHTML=f}}}})}),c={childList:!0,subtree:!0};b.observe(a,c)},setMapping:function(){4===this.readyState&&(200===this.status?(localStorage.setItem("assetsIdsToNames",this.responseText),Aniways.assetsIdsToNames=JSON.parse(this.responseText).iconIdsToNames):console.error("There was a problem with the keywords request."))},setAssets:function(){4===this.readyState&&(200===this.status?(localStorage.setItem("assetsNamesToUrls",this.responseText),Aniways.assetsNamesToUrls=JSON.parse(this.responseText).assets):console.error("There was a problem with the assets request."))}},AniwaysEncodingError.prototype=new Error,AniwaysEncodingError.prototype.constructor=AniwaysEncodingError,function(){var a=localStorage.getItem("assetsIdsToNames");if(null===a){var b=new XMLHttpRequest;b.onreadystatechange=Aniways.setMapping,b.open("GET",Aniways.keywordsPath,!0),b.send()}else Aniways.assetsIdsToNames=JSON.parse(a).iconIdsToNames;var c=localStorage.getItem("assetsNamesToUrls");if(null===c){var d=new XMLHttpRequest;d.onreadystatechange=Aniways.setAssets,d.open("GET",Aniways.assetsPath,!0),d.send()}else Aniways.assetsNamesToUrls=JSON.parse(c).assets}();