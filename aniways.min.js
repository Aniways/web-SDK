/*! Aniways 2014-02-17 */
function AniwaysEncodingError(a){this.message=a}window.Aniways={init:function(){return this.getMappings(),document.getElementsByClassName("aniways-wall").length>0?(this.addWallObserver(),!0):(console.log("Can't find element with aniways-wall class"),!1)},assetsIdsToNames:{},assetsNamesToUrls:{},keywordsPath:"http://api.aniways.com/v2/keywords",assetsPath:"http://api.aniways.com/v2/assets",unicodeToDecimal:function(a){for(var b="",c=4,d={"​":0,"‌":1,"‍":2,"﻿":3},e=0;e<a.length;e+=1){var f=d[a.charAt(e)];if(void 0===f)return-1;b+=d[a.charAt(e)]}return parseInt(b,c)},extractUnicodeEncodingData:function(a){for(var b={data:[],message:""},c={},d=a.length,e=0;d>e;e++)a.charCodeAt(e)>255&&(c={},c.phraseStart=e,a=this.removeAndRecordImageID(c,a,e),a=this.removeAndRecordDelimiter(c,"subPhraseStart",a,e),a=this.removeAndRecordDelimiter(c,"subPhraseEnd",a,e),a=this.removeAndRecordDelimiter(c,"phraseEnd",a,e),b.data.push(c),e=c.phraseEnd,d=a.length);return b.message=a,b},removeAndRecordImageID:function(a,b,c){var d={"​":5,"‌":11,"‍":17,"﻿":23},e=d[b.charAt(c)],f=b.substr(c+1,e);if(a.imageId=this.unicodeToDecimal(f),-1===a.imageId)throw new AniwaysEncodingError("Mallformed image encoding");return b.substr(0,c)+b.substr(c+e+1)},removeAndRecordDelimiter:function(a,b,c,d){var e=8203;if(a[b]=c.indexOf(String.fromCharCode(e),d),-1===a[b])throw new AniwaysEncodingError("Can't find "+b+" delimiter");return c.substr(0,a[b])+c.substr(a[b]+1)},decodeMessage:function(a){try{return this.unicodeDecoding(a)}catch(b){if(b instanceof AniwaysEncodingError)return this.urlDecoding(a)}},unicodeDecoding:function(a){for(var b=this.extractUnicodeEncodingData(a),c=b.message,d="",e=0,f=0;f<b.data.length;f++){var g=b.data[f],h=this.assetsNamesToUrls[this.assetsIdsToNames[g.imageId]];void 0===h?(d+=c.substring(e,g.phraseEnd),e=g.phraseEnd):(h=h.substring(0,h.indexOf("::")),d+=c.substring(e,g.subPhraseStart),d+="<img class='aniways-image' src='"+h+"'  title='"+c.substring(g.subPhraseStart,g.subPhraseEnd)+"'>",e=g.subPhraseEnd)}return d+=c.substring(e)},urlDecoding:function(a){var b=a.split("﻿﻿\n\n"),c=b[0];if(b.length<=1)return c;var d=this.extractUrlEncodingData(b[1]),e=0;for(var f in d)d.hasOwnProperty(f)&&-1!==f.indexOf("si")&&e++;for(var g="",h=0,i=0;e>i;i++){var j=this.assetsNamesToUrls[d["id"+i]];j=j.substring(0,j.indexOf("::")),g+=c.substring(h,parseInt(d["si"+i])),g+="<img class='aniways-image' src='"+j+"'  title='"+c.substring(parseInt(d["si"+i]),parseInt(d["si"+i])+parseInt(d["l"+i]))+"'>",h=parseInt(d["l"+i])+parseInt(d["si"+i])}return g+=c.substring(h)},extractUrlEncodingData:function(a){a=a.replace(/&amp;/g,"&"),a=a.match(/((([A-Za-z]{3,9}:(?:\/\/)?)(?:[-;:&=\+\$,\w]+@)?[A-Za-z0-9.-]+|(?:www.|[-;:&=\+\$,\w]+@)[A-Za-z0-9.-]+)((?:\/[\+~%\/.\w-_]*)?\??(?:[-\+=&;%@.\w_]*)#?(?:[\w]*))?)/);for(var b=a[0].split("?")[1],c=b.split("&"),d={},e=0;e<c.length;e++){var f=c[e].split("=");d[f[0]]=f[1]}return d},addWallObserver:function(a){function b(a){d(event.srcElement,a)}function c(a,b){var c=new f(function(a){a.forEach(function(a){if("childList"===a.type)for(var c=a.addedNodes,e=0;e<c.length;e++){var f=c[e];d(f,b)}})}),e={childList:!0,subtree:!0};c.observe(a,e)}function d(a,b){if("function"==typeof a.getElementsByClassName){var c;if(c="aniways-message"===a.className?[a]:a.getElementsByClassName("aniways-message"),c.length>0){var d=Aniways.decodeMessage(c[0].innerHTML);c[0].innerHTML=d,b()}}}var e=document.querySelector(".aniways-wall"),f=window.MutationObserver||window.WebKitMutationObserver;void 0!==f?c(e,a):e.addEventListener("DOMNodeInserted",function(){b(a)},!1)},setMapping:function(){4===this.readyState&&(200===this.status?Aniways.assetsIdsToNames=JSON.parse(this.responseText).iconIdsToNames:console.error("There was a problem with the keywords request."))},setAssets:function(){4===this.readyState&&(200===this.status?Aniways.assetsNamesToUrls=JSON.parse(this.responseText).assets:console.error("There was a problem with the assets request."))},getMappings:function(){var a=new XMLHttpRequest;a.onreadystatechange=this.setMapping,a.open("GET",this.keywordsPath,!0),a.send();var b=new XMLHttpRequest;b.onreadystatechange=this.setAssets,b.open("GET",this.assetsPath,!0),b.send()}},AniwaysEncodingError.prototype=new Error,AniwaysEncodingError.prototype.constructor=AniwaysEncodingError;